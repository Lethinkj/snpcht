<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let currentFilter = 'none';
    let hearts = [];

    // Debug: Confirm controls are rendered
    const controls = document.getElementById('controls');
    if (controls) {
        console.log('Controls div is rendered with', controls.children.length, 'buttons.');
    } else {
        console.error('Controls div not found.');
    }

    // Start video stream
    function startVideo() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    console.log('Camera started.');
                    document.getElementById('loading').style.display = 'none';
                    render();
                };
            })
            .catch(err => {
                console.error('Error accessing camera:', err);
                const loading = document.getElementById('loading');
                loading.innerHTML = 'Error: Could not access camera. <button onclick="startVideo()">Retry</button>';
            });
    }

    // Set filter
    function setFilter(filter) {
        currentFilter = filter;
        hearts = [];
        document.querySelectorAll('#controls button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`button[onclick="setFilter('${filter}')"]`).classList.add('active');
        console.log('Filter set to:', filter);
    }

    // Load heart image
    const heartImg = new Image();
    heartImg.src = './assets/heart.png';
    heartImg.onload = () => console.log('heart.png loaded successfully.');
    heartImg.onerror = () => {
        console.error('Failed to load heart.png');
        const loading = document.getElementById('loading');
        loading.innerText = 'Error: Could not load heart image.';
        document.querySelector('button[onclick="setFilter(\'hearts\')]').disabled = true;
        setTimeout(() => { loading.style.display = 'none'; }, 3000);
    };

    // Heart object
    class Heart {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = canvas.height;
            this.opacity = 1;
            this.speed = Math.random() * 1.5 + 0.5; // Slower speed: 0.5–2 pixels per frame
            this.size = Math.random() * 50 + 30; // Larger size: 30–80 pixels
            this.angle = Math.random() * Math.PI * 2; // For sinusoidal movement
            this.driftSpeed = Math.random() * 0.5 - 0.25; // Horizontal drift: -0.25 to 0.25 pixels
            this.rotation = Math.random() * Math.PI * 2; // Initial rotation
            this.rotationSpeed = Math.random() * 0.05 - 0.025; // Rotation speed: -0.025 to 0.025 radians
            this.direction = Math.random() * 0.2 - 0.1; // Slight directional variation (-0.1 to 0.1 radians)
        }
        update() {
            this.y -= this.speed * Math.cos(this.direction); // Move with slight angle
            this.x += this.driftSpeed + Math.sin(this.angle) * 2; // Add sinusoidal horizontal drift
            this.angle += 0.05; // Update angle for oscillation
            this.opacity -= 0.005; // Slower fade: lasts longer
            this.rotation += this.rotationSpeed; // Update rotation
        }
        draw() {
            ctx.save();
            ctx.globalAlpha = this.opacity;
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            ctx.drawImage(heartImg, -this.size / 2, -this.size / 2, this.size, this.size);
            ctx.restore();
        }
    }

    // Render loop
    function render() {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        if (currentFilter === 'hearts' && heartImg.complete && heartImg.naturalWidth !== 0) {
            if (Math.random() < 0.05 && hearts.length < 15) { // Reduced spawn rate, max 15 hearts
                hearts.push(new Heart());
            }
            hearts = hearts.filter(heart => heart.opacity > 0 && heart.y > -heart.size);
            hearts.forEach(heart => {
                heart.update();
                heart.draw();
            });
        } else if (currentFilter === 'grayscale') {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                data[i] = data[i + 1] = data[i + 2] = avg;
            }
            ctx.putImageData(imageData, 0, 0);
        }

        requestAnimationFrame(render);
    }

    // Capture photo
    function capturePhoto() {
        const link = document.createElement('a');
        link.download = 'snapchat-photo.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        console.log('Photo captured.');
    }

    // Initialize
    startVideo();
</script>
